<!DOCTYPE html>
<html>
<head>
<title>Bidadari Flat Selection</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://code.jquery.com/jquery-2.1.4.min.js" integrity="sha384-R4/ztc4ZlRqWjqIuvf6RX5yb/v90qNGx6fS48N0tRxiGkqveZETq72KgDVJCp2TC" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<style>
body {
    padding-top: 20px;
    padding-bottom: 20px;
}

.progress-bar-header {
    border-right: 1px solid #eee;
}

#selected-flats {
    display: none;
}

#static {
    margin-bottom: 10px;
}
</style>
<script>
var flat_types = ['2-Room Flexi (Short Lease/99-Year Lease)', '3-Room', '4-Room', '5-Room'];

var flat_style = {
    '2-Room Flexi (Short Lease/99-Year Lease)': 'success',
    '3-Room': 'info',
    '4-Room': 'danger',
    '5-Room': 'warning',
};

var flat_short_form = {
    '2-Room Flexi (Short Lease/99-Year Lease)': '2R',
    '3-Room': '3R',
    '4-Room': '4R',
    '5-Room': '5R',
};

function create_progress_bar(flat_type, header, num_booked, num_available) {
    var percentage = ((num_booked / num_available) * 100).toFixed(2);
    var width = ((num_booked / num_available) * 90).toFixed(2);

    var title = percentage + '%';
    var label = num_booked + ' / ' + num_available;

    var progress_bar = $('<div/>', {
        class: 'progress',
    });

    progress_bar.append($('<div/>', {
        class: 'progress-bar-header progress-bar progress-bar-'+flat_style[flat_type],
        'style': 'width: 10%',
    })
    .append($('<strong/>').append(header)));

    progress_bar.append($('<div/>', {
        class: 'progress-bar progress-bar-'+flat_style[flat_type],
        role: 'progressbar',
        'aria-valuenow': num_booked,
        'aria-valuemin': 0,
        'aria-valuemax': num_available,
        'style': 'min-width: 10%; width: ' + width + '%',
        'data-toggle': 'tooltip',
        'data-trigger': 'hover click focus',
        title: title
    }).append(label));

    return progress_bar;
}

function update_cumulative(units, div_id) {
    var output = flat_types.forEach(function(flat_type) {
        var filtered_units = units.filter(function(unit) {
            return unit.flat_type == flat_type;
        });

        var booked_units = filtered_units.filter(function(unit) {
            return unit.booked;
        });

        var num_booked = booked_units.length;
        var num_available = filtered_units.length;

        var header = flat_short_form[flat_type];
        var progress_bar = create_progress_bar(flat_type, header, num_booked, num_available);

        $(div_id).append(progress_bar);
    });
}

function update_blocks(units, flat_blocks, div_id) {
    for (var flat_type in flat_blocks) {
        var div = $('<div/>', {
            class: 'col-md-6'
        }).append($('<h5/>').append(flat_type + ' selected'));

        var blocks = flat_blocks[flat_type];
        var filtered_units = units.filter(function(unit) {
            return unit.flat_type == flat_type;
        });

        blocks.forEach(function(block) {
            var block_units = filtered_units.filter(function(unit) {
                return unit.block == block;
            });

            var booked_units = block_units.filter(function(unit) {
                return unit.booked;
            });

            var num_booked = booked_units.length;
            var num_available = block_units.length;

            var header = block;
            var progress_bar = create_progress_bar(flat_type, header, num_booked, num_available);

            div.append(progress_bar);
        });

        $(div_id).append(div);
    }
}

var flat_blocks_nov = {
    '2-Room Flexi (Short Lease/99-Year Lease)': ['101A', '102A', '104A'],
    '3-Room': ['101A', '102B', '103A', '103B', '104A', '115A', '115C', '118A'],
    '4-Room': ['101A', '102A', '102B', '103A', '103B', '104A', '105A', '105B', '106A', '106B', '115A', '115C', '118A'],
    '5-Room': ['105A', '105B', '106A', '106B']
};

var flat_blocks_feb = {
    '2-Room Flexi (Short Lease/99-Year Lease)': ['111A', '111B', '112A', '114A', '114B'],
    '3-Room': ['107A', '108A', '112B', '113A', '113B', '114A', '114B'],
    '4-Room': ['107A', '107B', '108A', '108B', '109A', '109B', '110A', '110B', '111A', '111B', '112A', '112B', '113A', '113B', '114A', '114B'],
    '5-Room': ['107A', '107B', '108B', '109A', '109B', '110A', '110B']
};

function populate_data(url, month, flat_blocks, callback) {
    $.get(url, function(data) {
        data = JSON.parse(data);

        var timestamp = new Date(data.timestamp);
        $('.last-updated-time-'+month).text(timestamp.toString());

        update_cumulative(data.units, '#all-blocks-'+month);
        update_blocks(data.units, flat_blocks, '#blocks-'+month);
        callback();
    });


}

$(function() {
    populate_data('https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari.json', 'nov', flat_blocks_nov, function() {
        populate_data('https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari_2.json', 'feb', flat_blocks_feb, function() {
            $('[data-toggle="tooltip"]').tooltip()

            $('#selected-flats').show();
            $('#loading').hide();
        })
    });
})
</script>

</head>

<body>
<div class="container">
    <div class="jumbotron">
        <h3>Bidadari  Flat Selection</h3>
        Now with February goodness
    </div>

    <div class="alert alert-danger">
        <strong>Warning:</strong> Data might not be accurate, always check <a href="http://services2.hdb.gov.sg/webapp/BP13AWFlatAvail/BP13SEstateSummary?sel=BTO">HDB's website</a> for the most up to date information.
    </div>

    <div class="row" id="loading">
        <div class="col-md-12">
            <h3>Loading data...</h3>
            <div class="progress">
                <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%">
                    <span class="sr-only">Loading</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row" id="static">
        <div class="col-md-12" id="data-source">
            <h3>Machine Readable Data Source</h3>
            For spreadsheet lovers and tech geeks, here is the full data crawled from HDB in nice machine readable formats, updated hourly if there are changes.

            <div class="row">
                <div class="col-sm-6">
                    <h4>February 16</h4>
                    <ul>
                    <li><a href="https://github.com/soedar/hdb_scraper/blob/master/data/bidadari_2.csv">CSV (Github Viewer)</a></li>
                    <li><a href="https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari_2.csv" download>CSV (Excel)</a></li>
                    <li><a href="https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari_2.json" download>JSON</a></li>
                    </ul>
                    <strong>Last updated:</strong> <span class="last-updated-time-feb"></span>
                </div>

                <div class="col-sm-6">
                    <h4>November 15</h4>
                    <ul>
                    <li><a href="https://github.com/soedar/hdb_scraper/blob/master/data/bidadari.csv">CSV (Github Viewer)</a></li>
                    <li><a href="https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari.csv" download>CSV (Excel)</a></li>
                    <li><a href="https://raw.githubusercontent.com/soedar/hdb_scraper/master/data/bidadari.json" download>JSON</a></li>
                    </ul>
                    <strong>Last updated:</strong> <span class="last-updated-time-nov"></span>
                </div>
            </div>
        </div>
    </div>

    <hr>

    <div id="selected-flats">
        <h3>Total Selected Flats</h3>
        <!-- Nav tabs -->
        <ul class="nav nav-tabs" role="tablist">
            <li role="presentation" class="active"><a href="#feb" aria-controls="feb" role="tab" data-toggle="tab">February 16</a></li>
            <li role="presentation"><a href="#nov" aria-controls="nov" role="tab" data-toggle="tab">November 15</a></li>
        </ul>

        <!-- Tab panes -->
        <div class="tab-content">
            <div role="tabpanel" class="tab-pane active" id="feb">
                <div class="row" id="blocks-feb">
                    <div class="col-md-12" id="all-blocks-feb">
                        <br>
                    </div>
                </div>
            </div>

            <div role="tabpanel" class="tab-pane" id="nov">
                <div class="row" id="blocks-nov">
                    <div class="col-md-12" id="all-blocks-nov">
                        <br>
                    </div>
                </div>
            </div>
        </div>
        <hr>
    </div>

    <div class="row">
        <div class="col-md-12">
            <h3>Technical</h3>
            Source code <a href="https://github.com/soedar/hdb_scraper">here</a>
        </div>
    </div>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-74754598-1', 'auto');
  ga('require', 'autotrack');
  ga('send', 'pageview');
</script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/0.6.1/autotrack.js"></script>
</body>

</html>
